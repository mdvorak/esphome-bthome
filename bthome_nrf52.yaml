# BTHome nRF52840 Example Configuration
# Broadcasts sensor data via BLE using BTHome v2 protocol
# Compatible with Home Assistant's BTHome integration
#
# Supported boards: Seeed XIAO BLE (nRF52840), other nRF52 boards
# Uses Zephyr RTOS BLE stack

esphome:
  name: bthome-nrf52
  friendly_name: BTHome nRF52 Sensor
  platformio_options:
    board_build.mcu: nrf52840

nrf52:
  board: xiao_ble
  # Bootloader options: adafruit, adafruit_nrf52_sd132, adafruit_nrf52_sd140_v6
  bootloader: adafruit

logger:

external_components:
  - source:
      type: local
      path: components
    components: [bthome]

#
# ========== DEEP SLEEP (optional, for battery operation) ==========
#

# Uncomment to enable deep sleep for battery-powered sensors
# deep_sleep:
#   run_duration: 15s
#   sleep_duration: 5min
#   wakeup_pin:
#     number: GPIO3
#     mode: INPUT_PULLUP
#     inverted: true  # Wake on LOW

#
# ========== I2C SENSORS ==========
#

# XIAO BLE I2C pins
i2c:
  sda: GPIO4
  scl: GPIO5
  scan: true

sensor:
  # BME280 temperature/humidity/pressure
  - platform: bme280_i2c
    address: 0x76
    temperature:
      id: bme_temperature
      name: "Temperature"
      oversampling: 16x
    humidity:
      id: bme_humidity
      name: "Humidity"
    pressure:
      id: bme_pressure
      name: "Pressure"
    update_interval: 30s

  # Battery voltage (XIAO BLE: GPIO29 = VBAT/2)
  - platform: adc
    pin: GPIO29
    id: battery_voltage
    name: "Battery Voltage"
    update_interval: 60s
    attenuation: auto
    filters:
      - multiply: 2.0  # Compensate for voltage divider

  # Battery percentage calculation
  - platform: template
    id: battery_percent
    name: "Battery Percent"
    unit_of_measurement: "%"
    lambda: |-
      float voltage = id(battery_voltage).state;
      // LiPo: 3.0V = 0%, 4.2V = 100%
      float percent = (voltage - 3.0) / (4.2 - 3.0) * 100.0;
      if (percent > 100) percent = 100;
      if (percent < 0) percent = 0;
      return percent;
    update_interval: 60s

#
# ========== BINARY SENSORS ==========
#

binary_sensor:
  # PIR motion sensor
  - platform: gpio
    pin:
      number: GPIO2
      mode: INPUT_PULLDOWN
    id: pir_motion
    name: "Motion"
    device_class: motion
    filters:
      - delayed_off: 30s

  # Door/window reed switch
  - platform: gpio
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
    id: door_contact
    name: "Door"
    device_class: door

#
# ========== BTHOME CONFIGURATION ==========
#

bthome:
  # Advertising interval (20ms - 10240ms)
  min_interval: 5s
  max_interval: 10s

  # TX power for nRF52: -40, -20, -16, -12, -8, -4, 0, 2, 3, 4, 5, 6, 7, 8 dBm
  tx_power: 4

  # Optional: Enable encryption (32 hex chars = 16 bytes)
  # Generate key: openssl rand -hex 16
  # encryption_key: "a1b2c3d4e5f6071829304a5b6c7d8e9f"

  # Sensor measurements to broadcast
  # See https://bthome.io/format/ for full specification
  #
  # Supported sensor types:
  #   Basic: packet_id, battery, temperature, humidity, pressure, illuminance
  #   Mass: mass_kg, mass_lb
  #   Environment: dewpoint, co2, tvoc, pm2_5, pm10, moisture
  #   Electrical: voltage, current, power, energy
  #   Count: count_uint8, count_uint16, count_uint32, count_sint8, count_sint16, count_sint32
  #   Distance: distance_mm, distance_m
  #   Motion: rotation, speed, acceleration, gyroscope, direction
  #   Volume: volume_l_01, volume_ml, volume_l, volume_storage, volume_flow_rate, water, gas, gas_uint32
  #   Time: duration, timestamp
  #   Other: uv_index, conductivity, precipitation, channel, rotational_speed
  sensors:
    - type: temperature
      id: bme_temperature
    - type: humidity
      id: bme_humidity
    - type: pressure
      id: bme_pressure
    - type: battery
      id: battery_percent

  # Binary sensor measurements to broadcast
  # Supported: generic_boolean, power, opening, battery_low, battery_charging,
  #            carbon_monoxide, cold, connectivity, door, garage_door, gas,
  #            heat, light, lock, moisture_binary, motion, moving, occupancy,
  #            plug, presence, problem, running, safety, smoke, sound, tamper,
  #            vibration, window
  binary_sensors:
    - type: motion
      id: pir_motion
      advertise_immediately: true
    - type: door
      id: door_contact
      advertise_immediately: true
