# BTHome Weather Station Display - Lilygo T5 4.7"
# Receives BTHome sensor data and displays on e-paper
#
# Configure your BTHome sensor MAC addresses below

substitutions:
  device_name: weather-display
  friendly_name: Weather Display
  # BTHome weather station MAC address (corrected byte order)
  weather_station_mac: "08:B9:5F:D1:E3:4E"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  on_boot:
    priority: -100 # Run after everything else
    then:
    - delay: 2s
    - logger.log: "Boot complete, BLE should be ready"

# Import reusable packages
packages:
  board: !include packages/lilygo_t5_47_base.yaml
  fonts: !include packages/fonts_weather.yaml
  ble_receiver: !include packages/bthome_receiver.yaml
  widgets: !include packages/display_widgets.yaml

logger:
  level: WARN
api:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: LIGHT
  ap: {}

ota:
- platform: esphome

web_server:
  port: 80

time:
- platform: sntp
  id: ntp_time
  timezone: Europe/Ljubljana
  on_time_sync:
  - component.update: epaper
  on_time:
  # Reset daily rain counter at midnight
  - seconds: 0
    minutes: 0
    hours: 0
    then:
    - lambda: id(rain_daily).publish_state(0);

# Historical graphs for sensor data (24h history)
graph:
- id: graph_temp
  sensor: outdoor_temp
  duration: 24h
  width: 220
  height: 155
  x_grid: 6h
  y_grid: 10
  min_value: -10
  max_value: 40

- id: graph_humidity
  sensor: outdoor_humidity
  duration: 24h
  width: 220
  height: 155
  x_grid: 6h
  y_grid: 25
  min_value: 0
  max_value: 100

- id: graph_wind
  sensor: wind_speed
  duration: 24h
  width: 220
  height: 155
  x_grid: 6h
  y_grid: 5
  min_value: 0
  max_value: 20

- id: graph_rain
  sensor: rain
  duration: 24h
  width: 220
  height: 155
  x_grid: 6h
  y_grid: 10
  min_value: 0
  max_value: 50

# Refresh display every minute to prevent degradation
interval:
- interval: 1min
  then:
  - component.update: epaper

# Button actions (extend from base package)
binary_sensor:
- id: !extend btn_1
  on_press:
  - component.update: epaper

- id: !extend btn_2
  on_press:
  - logger.log: "Button 2 pressed"

- id: !extend btn_3
  on_press:
  - logger.log: "Button 3 pressed"

# All-in-one BTHome weather station
# Device sends multiple packets updating different sensors
# ESPHome aggregates all measurements from the same MAC
sensor:
- platform: bthome_receiver
  mac_address: ${weather_station_mac}
  # Temperature (0x45 = temperature_01, 0.1°C resolution)
  temperature_01:
    name: "Temperature"
    id: outdoor_temp
  # Humidity (0x2E = humidity_uint8, 1% resolution)
  humidity_uint8:
    name: "Humidity"
    id: outdoor_humidity
  # Rain (precipitation object 0x5F) - this is cumulative total from device
  precipitation:
    name: "Rain Total (Lifetime)"
    id: rain_total
    internal: true
    on_value:
      then:
      - lambda: |-
          // Calculate rain delta (difference from last reading)
          static float last_rain = NAN;
          float current = id(rain_total).state;
          if (!std::isnan(last_rain) && current >= last_rain) {
            float delta = current - last_rain;
            // Update rain rate (delta since last update)
            id(rain_rate).publish_state(delta);
            // Accumulate daily rain
            id(rain_daily).publish_state(id(rain_daily).state + delta);
          } else if (std::isnan(id(rain_daily).state)) {
            // Initialize daily rain to 0
            id(rain_daily).publish_state(0);
          }
          last_rain = current;
  # Wind speed (speed object 0x44) - device sends two values: speed and gusts
  speed:
  - name: "Wind Speed"
    id: wind_speed
    index: 0
  - name: "Wind Gusts"
    id: wind_gusts_sensor
    index: 1
  # Wind direction (direction object 0x5E)
  direction:
    name: "Wind Direction"
    id: wind_direction
  # Illuminance (0x05)
  illuminance:
    name: "Illuminance"
    id: illuminance
  # Battery (0x01)
  battery:
    name: "Weather Station Battery"
  # Pressure (0x04)
  pressure:
    name: "Pressure"
    id: pressure_sensor
  # Dewpoint (0x08)
  dewpoint:
    name: "Dewpoint"
    id: dewpoint_sensor

# Rain rate (change since last reading)
- platform: template
  id: rain_rate
  name: "Rain Rate"
  unit_of_measurement: "mm"
  accuracy_decimals: 1
  icon: "mdi:weather-pouring"

# Daily accumulated rain (resets at midnight)
- platform: template
  id: rain_daily
  name: "Rain Today"
  unit_of_measurement: "mm"
  accuracy_decimals: 1
  icon: "mdi:weather-rainy"
  lambda: |-
    if (std::isnan(id(rain_daily).state)) return 0.0f;
    return id(rain_daily).state;
  update_interval: never

# Alias for display (uses daily rain)
- platform: template
  id: rain
  name: "Rain"
  unit_of_measurement: "mm"
  accuracy_decimals: 1
  lambda: return id(rain_daily).state;
  update_interval: 10s

# Solar power calculated from illuminance (1 W/m2 ≈ 120 lux)
- platform: template
  id: solar_power
  name: "Solar Power"
  unit_of_measurement: "W/m2"
  accuracy_decimals: 0
  icon: "mdi:solar-power"
  lambda: |-
    if (id(illuminance).has_state() && !std::isnan(id(illuminance).state)) {
      return id(illuminance).state / 120.0;
    }
    return NAN;
  update_interval: 10s

# Wind gusts reference (uses sensor from bthome_receiver with index: 1)
- platform: template
  id: wind_gusts
  name: "Wind Gusts Display"
  unit_of_measurement: "m/s"
  accuracy_decimals: 1
  internal: true
  lambda: return id(wind_gusts_sensor).state;
  update_interval: 10s

# Extend display with weather layout - compass style
display:
- id: !extend epaper
  lambda: |-
    // Screen: 960x540
    #define W 960
    #define H 540
    #define M 15

    // MDI icon codepoints
    #define ICON_THERMOMETER "\U000F050F"
    #define ICON_HUMIDITY "\U000F058E"
    #define ICON_RAIN "\U000F0597"
    #define ICON_SOLAR "\U000F05A8"
    #define ICON_DEWPOINT "\U000F0F54"

    // === HEADER: Location + Date/Time ===
    it.print(M, 8, id(font_label), TextAlign::TOP_LEFT, "Weather Station");
    it.strftime(W - M, 8, id(font_label), TextAlign::TOP_RIGHT, "%a, %d %b %Y @ %H:%M", id(ntp_time).now());

    // === WIND COMPASS (left side) ===
    int cx = 130;  // compass center x
    int cy = 175;  // compass center y
    int r = 100;   // compass radius

    // Draw compass circle (thick - 4 concentric circles)
    it.circle(cx, cy, r);
    it.circle(cx, cy, r - 1);
    it.circle(cx, cy, r - 2);
    it.circle(cx, cy, r - 3);

    // Draw cardinal directions
    it.print(cx, cy - r + 15, id(font_label), TextAlign::TOP_CENTER, "N");
    it.print(cx, cy + r - 15, id(font_label), TextAlign::BOTTOM_CENTER, "S");
    it.print(cx - r + 15, cy, id(font_label), TextAlign::CENTER_LEFT, "W");
    it.print(cx + r - 15, cy, id(font_label), TextAlign::CENTER_RIGHT, "E");

    // Intercardinal
    int ic_off = (r - 20) * 0.707;  // 45 degree offset
    it.print(cx + ic_off, cy - ic_off, id(font_footer), TextAlign::CENTER, "NE");
    it.print(cx + ic_off, cy + ic_off, id(font_footer), TextAlign::CENTER, "SE");
    it.print(cx - ic_off, cy + ic_off, id(font_footer), TextAlign::CENTER, "SW");
    it.print(cx - ic_off, cy - ic_off, id(font_footer), TextAlign::CENTER, "NW");

    // Draw tick marks (thick - double lines)
    for (int i = 0; i < 360; i += 30) {
      float rad = i * M_PI / 180.0;
      int x1 = cx + (r - 10) * sin(rad);
      int y1 = cy - (r - 10) * cos(rad);
      int x2 = cx + r * sin(rad);
      int y2 = cy - r * cos(rad);
      it.line(x1, y1, x2, y2);
      it.line(x1 + 1, y1, x2 + 1, y2);
    }

    // Wind direction arrow
    if (id(wind_direction).has_state() && !std::isnan(id(wind_direction).state)) {
      float dir = id(wind_direction).state;
      float rad = dir * M_PI / 180.0;

      // Arrow pointing in wind direction
      int arrow_len = r - 25;
      int ax = cx + arrow_len * sin(rad);
      int ay = cy - arrow_len * cos(rad);

      // Draw arrow line (thick - triple lines)
      it.line(cx, cy, ax, ay);
      it.line(cx + 1, cy, ax + 1, ay);
      it.line(cx - 1, cy, ax - 1, ay);

      // Arrow head (thick)
      float head_angle = 25 * M_PI / 180.0;
      int head_len = 15;
      int hx1 = ax - head_len * sin(rad - head_angle);
      int hy1 = ay + head_len * cos(rad - head_angle);
      int hx2 = ax - head_len * sin(rad + head_angle);
      int hy2 = ay + head_len * cos(rad + head_angle);
      it.line(ax, ay, hx1, hy1);
      it.line(ax + 1, ay, hx1 + 1, hy1);
      it.line(ax, ay, hx2, hy2);
      it.line(ax + 1, ay, hx2 + 1, hy2);

      // Direction text in center
      const char* dir_str = "N";
      if (dir >= 337.5 || dir < 22.5) dir_str = "N";
      else if (dir < 67.5) dir_str = "NE";
      else if (dir < 112.5) dir_str = "E";
      else if (dir < 157.5) dir_str = "SE";
      else if (dir < 202.5) dir_str = "S";
      else if (dir < 247.5) dir_str = "SW";
      else if (dir < 292.5) dir_str = "W";
      else dir_str = "NW";
      it.printf(cx, cy - 25, id(font_label), TextAlign::CENTER, "%s", dir_str);
      it.printf(cx, cy + 35, id(font_footer), TextAlign::CENTER, "%.0f°", dir);
    }

    // Wind speed in compass center
    if (id(wind_speed).has_state() && !std::isnan(id(wind_speed).state)) {
      it.printf(cx, cy + 5, id(font_title), TextAlign::CENTER, "%.1f", id(wind_speed).state);
      it.print(cx, cy + 55, id(font_footer), TextAlign::CENTER, "m/s");
    } else {
      it.print(cx, cy + 5, id(font_title), TextAlign::CENTER, "--");
    }

    // === MAIN READINGS (center-right) ===
    int main_x = 280;
    int main_y = 60;

    // Large Temperature
    it.print(main_x, main_y, id(icon_mdi), TextAlign::TOP_LEFT, ICON_THERMOMETER);
    if (id(outdoor_temp).has_state() && !std::isnan(id(outdoor_temp).state)) {
      it.printf(main_x + 60, main_y - 10, id(font_value), TextAlign::TOP_LEFT, "%.1f°C", id(outdoor_temp).state);
    } else {
      it.print(main_x + 60, main_y - 10, id(font_value), TextAlign::TOP_LEFT, "--°C");
    }

    // Large Humidity next to temp
    it.print(main_x + 250, main_y, id(icon_mdi), TextAlign::TOP_LEFT, ICON_HUMIDITY);
    if (id(outdoor_humidity).has_state() && !std::isnan(id(outdoor_humidity).state)) {
      it.printf(main_x + 310, main_y - 10, id(font_value), TextAlign::TOP_LEFT, "%.0f%%", id(outdoor_humidity).state);
    } else {
      it.print(main_x + 310, main_y - 10, id(font_value), TextAlign::TOP_LEFT, "--%");
    }

    // === SECONDARY READINGS ROW ===
    int sec_y = main_y + 80;

    // Rain
    it.print(main_x, sec_y, id(icon_mdi), TextAlign::TOP_LEFT, ICON_RAIN);
    it.print(main_x + 55, sec_y + 5, id(font_label), TextAlign::TOP_LEFT, "Rain");
    if (id(rain).has_state() && !std::isnan(id(rain).state)) {
      it.printf(main_x + 55, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "%.1f mm", id(rain).state);
    } else {
      it.print(main_x + 55, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "-- mm");
    }

    // Solar
    it.print(main_x + 180, sec_y, id(icon_mdi), TextAlign::TOP_LEFT, ICON_SOLAR);
    it.print(main_x + 235, sec_y + 5, id(font_label), TextAlign::TOP_LEFT, "Solar");
    if (id(solar_power).has_state() && !std::isnan(id(solar_power).state)) {
      it.printf(main_x + 235, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "%.0f W/m2", id(solar_power).state);
    } else {
      it.print(main_x + 235, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "-- W/m2");
    }

    // Wind Gusts
    it.print(main_x + 360, sec_y + 5, id(font_label), TextAlign::TOP_LEFT, "Gusts");
    if (id(wind_gusts).has_state() && !std::isnan(id(wind_gusts).state)) {
      it.printf(main_x + 360, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "%.1f m/s", id(wind_gusts).state);
    } else {
      it.print(main_x + 360, sec_y + 30, id(font_unit), TextAlign::TOP_LEFT, "-- m/s");
    }

    // === THIRD ROW: Dewpoint and Pressure ===
    int third_y = sec_y + 70;

    // Dewpoint
    it.print(main_x, third_y, id(icon_mdi), TextAlign::TOP_LEFT, ICON_DEWPOINT);
    it.print(main_x + 55, third_y + 5, id(font_label), TextAlign::TOP_LEFT, "Dewpoint");
    if (id(dewpoint_sensor).has_state() && !std::isnan(id(dewpoint_sensor).state)) {
      it.printf(main_x + 55, third_y + 30, id(font_unit), TextAlign::TOP_LEFT, "%.1f C", id(dewpoint_sensor).state);
    } else {
      it.print(main_x + 55, third_y + 30, id(font_unit), TextAlign::TOP_LEFT, "-- C");
    }

    // Pressure
    it.print(main_x + 180, third_y + 5, id(font_label), TextAlign::TOP_LEFT, "Pressure");
    if (id(pressure_sensor).has_state() && !std::isnan(id(pressure_sensor).state)) {
      it.printf(main_x + 180, third_y + 30, id(font_unit), TextAlign::TOP_LEFT, "%.0f hPa", id(pressure_sensor).state);
    } else {
      it.print(main_x + 180, third_y + 30, id(font_unit), TextAlign::TOP_LEFT, "-- hPa");
    }

    // === LINE GRAPHS AREA (bottom) - 24h history ===
    int graph_y = 325;  // Moved lower to avoid text clipping
    int graph_h = 155;
    int graph_w = 220;
    int graph_spacing = (W - 4 * graph_w) / 5;

    // Temperature graph
    int gx = graph_spacing;
    it.print(gx, graph_y - 8, id(font_footer), TextAlign::BOTTOM_LEFT, "Temperature (°C)");
    it.rectangle(gx - 2, graph_y - 2, graph_w + 4, graph_h + 4);
    it.rectangle(gx - 3, graph_y - 3, graph_w + 6, graph_h + 6);
    it.graph(gx, graph_y, id(graph_temp));

    // Humidity graph
    gx += graph_w + graph_spacing;
    it.print(gx, graph_y - 8, id(font_footer), TextAlign::BOTTOM_LEFT, "Humidity (%)");
    it.rectangle(gx - 2, graph_y - 2, graph_w + 4, graph_h + 4);
    it.rectangle(gx - 3, graph_y - 3, graph_w + 6, graph_h + 6);
    it.graph(gx, graph_y, id(graph_humidity));

    // Wind graph
    gx += graph_w + graph_spacing;
    it.print(gx, graph_y - 8, id(font_footer), TextAlign::BOTTOM_LEFT, "Wind (m/s)");
    it.rectangle(gx - 2, graph_y - 2, graph_w + 4, graph_h + 4);
    it.rectangle(gx - 3, graph_y - 3, graph_w + 6, graph_h + 6);
    it.graph(gx, graph_y, id(graph_wind));

    // Rain graph
    gx += graph_w + graph_spacing;
    it.print(gx, graph_y - 8, id(font_footer), TextAlign::BOTTOM_LEFT, "Rain (mm)");
    it.rectangle(gx - 2, graph_y - 2, graph_w + 4, graph_h + 4);
    it.rectangle(gx - 3, graph_y - 3, graph_w + 6, graph_h + 6);
    it.graph(gx, graph_y, id(graph_rain));

    // === FOOTER === (thick line)
    it.line(M, H - 30, W - M, H - 30);
    it.line(M, H - 31, W - M, H - 31);
    it.strftime(M, H - 5, id(font_footer), TextAlign::BASELINE_LEFT, "Last update: %H:%M:%S", id(ntp_time).now());

    // Battery indicator in footer (right side)
    float batt = id(battery_percent).state;
    if (!std::isnan(batt)) {
      int batt_x = W - M - 80;
      int batt_y = H - 20;
      it.rectangle(batt_x, batt_y, 30, 12);
      it.filled_rectangle(batt_x + 30, batt_y + 3, 3, 6);
      int fill_w = (int)(26 * batt / 100.0);
      if (fill_w > 0) it.filled_rectangle(batt_x + 2, batt_y + 2, fill_w, 8);
      it.printf(batt_x + 40, batt_y + 6, id(font_footer), TextAlign::CENTER_LEFT, "%.0f%%", batt);
    }

button:
- platform: restart
  name: "Restart"

- platform: template
  name: "Refresh Display"
  icon: "mdi:refresh"
  on_press:
  - component.update: epaper
